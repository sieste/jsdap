<html>
    <head>
        <style type="text/css">
            body {
                font-size: 100%;
                padding: 0.5em;
            }

            #map {
                height: 340px;
                border: 1px solid black;
            }

            #variables {
            }

            #timeplot {
                border: 1px solid black;
                height: 200px;
            }
        </style>

        <script type="text/javascript" src="http://static.simile.mit.edu/timeplot/api/1.0/timeplot-api.js"></script>
        <script type="text/javascript" src="js/OpenLayers/lib/OpenLayers.js"></script>
        <script type="text/javascript" src="../jsdap.js"></script>

        <script type="text/javascript">
            var map, timeplot, eventSource;
            var activeBuoy;
            var baseurl = "http://dapper.pmel.noaa.gov/dapper/epic/tao_time_series.cdp";

            function onLoad() {
                // Load map.
                OpenLayers.ProxyHost = '/proxy/';
                map = new OpenLayers.Map('map');
                map.addControl(new OpenLayers.Control.LayerSwitcher());

                var layer = new OpenLayers.Layer.WMS('OpenLayers WMS',
                        'http://labs.metacarta.com/wms/vmap0',
                        {layers: 'basic'}, 
                        {wrapDateLine: true});
                map.addLayer(layer);
                map.setCenter(new OpenLayers.LonLat(-145, 0), 3);

                // Add layer for the buoys.
                var buoys = new OpenLayers.Layer.Markers('TAO array');
                map.addLayer(buoys);

                // Add buoys. Apparently, dapper always returns the data
                //  in the order lon/lat/_id, independently of the projection.
                var url = baseurl + ".dods?location.lon,location.lat,location._id";
                loadData(url, function(data) {
                    var seqData = data[0];
                    var station, lon, lat, _id;
                    for (var i=0; i<seqData.length; i++) {
                        station = seqData[i];
                        lon = station[0] - 360.0;
                        lat = station[1];
                        _id = station[2];
                        
                        var marker = new OpenLayers.Marker(new OpenLayers.LonLat(lon,lat));
                        marker.metadata = {id: _id, lat: lat, lon: lon};
                        marker.events.register('click', marker, toggleBuoy);
                        buoys.addMarker(marker);
                    }
                }, '/proxy/');

                loadDataset(baseurl, function(dataset) {
                    var series = dataset.location.time_series;

                    var html = '<p>Select one or more variables:</p><p>';
                    var name, id;
                    for (child in series) {
                        if (series[child].attributes) {
                            name = series[child].attributes.long_name;
                            id = series[child].id;
                            html += '<input class="variable" type="checkbox" name="' + id + '" id="' + id + '" value="' + id + '" /><label for="' + id + '">&nbsp;' + name + '</label><br>';
                        }
                    }
                    html += '</p><p><input type="button" onclick="plotData()" value="Plot" /></p>';

                    var div = document.getElementById('variables');
                    div.innerHTML = html;
                }, '/proxy/');

                // Load timeplot.
                eventSource = new Timeplot.DefaultEventSource();
                var plotInfo = [
                    Timeplot.createPlotInfo({
                        id: "plot1"
                    })
                ];
                timeplot = Timeplot.create(document.getElementById('timeplot'), plotInfo);
            }

            function plotData() {
                var url = baseurl + '.dods?';
                var vars = document.getElementsByTagName('input');
                var selected = 0;
                for (var i=0; i<vars.length; i++) {
                    if ((vars[i].checked) && (vars[i].className == 'variable')) {
                        url += vars[i].id + ',';
                        selected++;
                    }
                }
                if (!selected) return;

                url = url.replace(/,$/, '');
                url += ',location.time_series.time';
                url += '&location.time>1.0e12';
                url += '&location._id=55';
                
                loadData(url, function(data) {
                    var timeSeries = data[0][0][0];
                    eventSource.loadJSON(timeSeries, url);
                }, '/proxy/');
            }

            var resizeTimerID = null;
            function onResize() {
                if (resizeTimerID == null) {
                    resizeTimerID = window.setTimeout(function() {
                        resizeTimerID = null;
                        timeplot.repaint();
                    }, 100);
                }
            }

            function toggleBuoy(e) {
            }

            function decToDeg(dec, axis) {
                var deg = parseInt(dec);
                var min = parseInt((dec - deg) * 60);
                var sec = parseInt(((dec - deg) * 60 - min) * 60);
                var index = deg > 0 ? axis[0] : axis[1];
                var minPad = Math.abs(min) < 10 ? '0' : '';
                var secPad = Math.abs(sec) < 10 ? '0' : '';
                return Math.abs(deg) + '&deg;' + index + ' ' + minPad + Math.abs(min) + "'" + ' ' + secPad + Math.abs(sec) + '"';
            }
        </script>
    </head>
    <body onload="onLoad();" onresize="onResize();">
        <div id="description">
            <p>This demo downloads the position of the TAO buoys from a Dapper server, plotting them on an OpenLayers map. Each buoy can then be selected for data download. The contained variables (wind direction, temperature quality, etc.) are also downloaded from the server using a <code>DAS</code> request. The data is then plotted using SIMILE's Timeplot widget.</p>
        </div>
        <div id="map"></div>
        <div id="variables"></div>
        <div id="timeplot"></div>
    </body>
</html>
