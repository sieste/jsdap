<html>
    <head>
        <style type="text/css">
            body {
                font-size: 100%;
                padding: 0.5em;
            }

            #map {
                height: 340px;
                border: 1px solid black;
            }

            #variables {
            }

            #timeplot {
                border: 1px solid black;
                height: 200px;
            }
        </style>

        <script type="text/javascript" src="http://code.google.com/p/jqueryjs/downloads/detail?name=jquery-1.2.1.pack.js"></script>
        <script type="text/javascript" src="http://static.simile.mit.edu/timeplot/api/1.0/timeplot-api.js"></script>
        <script type="text/javascript" src="js/OpenLayers/lib/OpenLayers.js"></script>
        <script type="text/javascript" src="../jsdap.js"></script>

        <script type="text/javascript">
            var map, timeplot, eventSource, buoys;
            var activeBuoy;
            var baseurl = "http://dapper.pmel.noaa.gov/dapper/epic/tao_time_series.cdp";

            function onLoad() {
                // Load map.
                OpenLayers.ProxyHost = '/proxy/';
                map = new OpenLayers.Map('map');
                map.addControl(new OpenLayers.Control.LayerSwitcher());

                var layer = new OpenLayers.Layer.WMS('OpenLayers WMS',
                        'http://labs.metacarta.com/wms/vmap0',
                        {layers: 'basic'}, 
                        {wrapDateLine: true});
                map.addLayer(layer);
                map.setCenter(new OpenLayers.LonLat(-145, 0), 3);

                // Add layer for the buoys.
                buoys = new OpenLayers.Layer.Markers('TAO array');
                map.addLayer(buoys);

                // Add buoys. Apparently, dapper always returns the data
                //  in the order lon/lat/_id, independently of the projection.
                var url = baseurl + ".dods?location.lon,location.lat,location._id";
                loadData(url, function(data) {
                    var seqData = data[0];
                    var station, lon, lat, _id;
                    var size = new OpenLayers.Size(21,25);
                    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                    var icon = new OpenLayers.Icon('js/OpenLayers/img/marker-blue.png',size,offset);
                    for (var i=0; i<seqData.length; i++) {
                        station = seqData[i];
                        lon = station[0] - 360.0;
                        lat = station[1];
                        _id = station[2];
                        
                        var marker = new OpenLayers.Marker(new OpenLayers.LonLat(lon,lat), icon.clone());
                        marker.metadata = {id: _id, lat: lat, lon: lon};
                        marker.events.register('click', marker, function() {
                            // Reset all buttons.
                            for (var i=0; i<buoys.markers.length; i++) {
                                buoys.markers[i].icon.imageDiv.firstChild.setAttribute(
                                        'src', 'js/OpenLayers/img/marker-blue.png');
                            }
                            this.icon.imageDiv.firstChild.setAttribute('src', 'js/OpenLayers/img/marker.png');
                            selectBuoy(this.metadata);
                        });
                        buoys.addMarker(marker);
                    }
                }, '/proxy/');

                loadDataset(baseurl, function(dataset) {
                    var series = dataset.location.time_series;

                    $('#variables').append('<p id="buoy">No buoy selected.</p>');
                    var name, id;
                    for (child in series) {
                        if ((series[child].attributes) && (child != 'time')) {
                            name = series[child].attributes.long_name;
                            id = series[child].id;
                            $('#variables').append('<input class="variable" disabled="disabled" type="checkbox" name="' + id + '" id="' + id + '" value="' + id + '" /><label for="' + id + '">&nbsp;' + name + '</label><br />');
                        }
                    }
                    $('<p><input type="button" value="Plot" /></p>').click(plotData).appendTo('#variables');
                }, '/proxy/');

                // Load timeplot.
                eventSource = new Timeplot.DefaultEventSource();
                var plotInfo = [
                    Timeplot.createPlotInfo({
                        id: "plot1"
                    })
                ];
                timeplot = Timeplot.create(document.getElementById('timeplot'), plotInfo);
            }

            function selectBuoy(metadata) {
                $('#buoy').html('Buoy ' + metadata.id + ': ' + decToDeg(metadata.lat, 'NS') + ' ' + decToDeg(metadata.lon, 'EW'));
                $('input.variable').removeAttr('disabled');
            }

            function plotData() {
                var url = baseurl + '.dods?';
                var vars = document.getElementsByTagName('input');
                var selected = 0;
                for (var i=0; i<vars.length; i++) {
                    if ((vars[i].checked) && (vars[i].className == 'variable')) {
                        url += vars[i].id + ',';
                        selected++;
                    }
                }
                if (!selected) return;

                // Get buoy id.
                for (var i=0; i<buoys.markers.length; i++) {
                    var marker = buoys.markers[i];
                    if (marker.icon.imageDiv.firstChild.getAttribute('src') == 'js/OpenLayers/img/marker.png') {
                        var id = marker.metadata.id;
                        break;
                    }
                }

                url += 'location.time_series.time';
                url += '&location.time>1.0e12';
                url += '&location._id=' + id;
                
                loadData(url, function(data) {
                    var timeSeries = data[0][0][0];
                    //eventSource.loadJSON(timeSeries, url);
                }, '/proxy/');
            }

            var resizeTimerID = null;
            function onResize() {
                if (resizeTimerID == null) {
                    resizeTimerID = window.setTimeout(function() {
                        resizeTimerID = null;
                        timeplot.repaint();
                    }, 100);
                }
            }

            function decToDeg(dec, axis) {
                var deg = parseInt(dec);
                var min = parseInt((dec - deg) * 60);
                var sec = parseInt(((dec - deg) * 60 - min) * 60);
                var index = deg > 0 ? axis[0] : axis[1];
                var minPad = Math.abs(min) < 10 ? '0' : '';
                var secPad = Math.abs(sec) < 10 ? '0' : '';
                return Math.abs(deg) + '&deg;' + minPad + Math.abs(min) + "'" + secPad + Math.abs(sec) + '"' + index;
            }
        </script>
    </head>
    <body onload="onLoad();" onresize="onResize();">
        <div id="description">
            <p>This demo downloads the position of the <a href="http://www.pmel.noaa.gov/tao/">TAO buoys</a> from a <a href="http://dapper.pmel.noaa.gov/dapper/epic/">Dapper server</a> using a <code>DODS</code> request, plotting them on an <a href="http://openlayers.org/">OpenLayers</a> map. Each buoy can then be selected for data download. The contained variables (wind direction, temperature quality, etc.) are also downloaded from the server using <code>DDS/DAS</code> requests. The data is then plotted using <a href="http://simile.mit.edu/">SIMILE</a>'s <a href"http://simile.mit.edu/timeplot/">Timeplot</a> widget.</p>
        </div>
        <div id="map"></div>
        <div id="variables"></div>
        <div id="timeplot"></div>
    </body>
</html>
